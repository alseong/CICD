version: 2.1

parameters:
  image-tag:
    type: string
    default: "current"

executors:
  node-executor:
    docker:
      - image: cimg/node:18.17
    working_directory: ~/project

jobs:
  install-dependencies:
    executor: node-executor
    steps:
      - checkout
      - run:
          name: Install npm dependencies
          command: |
            npm install
            echo "âœ… All dependencies installed!"
      - save_cache:
          key: v1-dependencies-{{ checksum "package.json" }}
          paths:
            - node_modules

  test-react-functionality-knapsack:
    executor: node-executor
    parallelism: 4
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "package.json" }}
      - run:
          name: Install dependencies if not cached
          command: |
            if [ ! -d "node_modules" ] || [ ! -d "node_modules/@knapsack-pro" ]; then
              echo "ðŸ”„ Installing dependencies..."
              npm ci
            else
              echo "âœ… Dependencies found in cache"
              # Verify critical dependencies are properly installed
              if [ ! -f "node_modules/emittery/index.js" ] || [ ! -f "node_modules/emittery/maps.js" ]; then
                echo "ðŸ”„ Detected corrupted dependencies, reinstalling..."
                rm -rf node_modules
                # Use npm install instead of npm ci to handle package-lock.json sync issues
                npm install
              fi
            fi
      - run:
          name: Run React tests with Knapsack Pro
          command: |
            mkdir -p test-results
            npx knapsack-pro-jest --runInBand
            echo "âœ… Knapsack Pro React tests completed"
          environment:
            CI: true
            KNAPSACK_PRO_TEST_FILE_PATTERN: "{src/**/*.test.js,src/**/*.spec.js}"
            JEST_JUNIT_OUTPUT_DIR: test-results
            JEST_JUNIT_OUTPUT_NAME: jest-junit.xml
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: coverage
          destination: coverage-report

workflows:
  test:
    jobs:
      - install-dependencies
      - test-react-functionality-knapsack:
          requires:
            - install-dependencies

  
  
